<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Learn Go Pipelines by building keyword search tool - Ray Yang</title><meta name=description content="Photo by Gioia M. on Unsplash   Today&rsquo;s challenge is about working with concurrency in Go - Goroutines, Channels, and Pipelines. The following exercise is from the book, “Mastering Go: Create Golang production applications using network libraries, concurrency, machine learning, and advanced data structures” by Mihalis Tsoukalos. The book not only contains a lot of useful examples and best practices but also helps you understand the capability of Go in depth via well-written descriptions."><meta name=author content="rayspock"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Ray Yang","url":"https:\/\/rayspock.com\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/rayspock.com\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/rayspock.com\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/rayspock.com\/posts\/go-pipeline\/","name":"Learn go pipelines by building keyword search tool"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"rayspock"},"headline":"Learn Go Pipelines by building keyword search tool","description":"Photo by Gioia M. on Unsplash   Today\u0026rsquo;s challenge is about working with concurrency in Go - Goroutines, Channels, and Pipelines. The following exercise is from the book, “Mastering Go: Create Golang production applications using network libraries, concurrency, machine learning, and advanced data structures” by Mihalis Tsoukalos. The book not only contains a lot of useful examples and best practices but also helps you understand the capability of Go in depth via well-written descriptions.","inLanguage":"en","wordCount":1278,"datePublished":"2022-09-04T00:00:00","dateModified":"2022-09-04T00:00:00","image":"https:\/\/rayspock.com\/img\/portfolio.png","keywords":["100daysofcode, learning-journey, golang, concurrency, pipeline"],"mainEntityOfPage":"https:\/\/rayspock.com\/posts\/go-pipeline\/","publisher":{"@type":"Organization","name":"https:\/\/rayspock.com\/","logo":{"@type":"ImageObject","url":"https:\/\/rayspock.com\/img\/portfolio.png","height":60,"width":60}}}</script><meta property="og:title" content="Learn Go Pipelines by building keyword search tool"><meta property="og:description" content="Photo by Gioia M. on Unsplash   Today&rsquo;s challenge is about working with concurrency in Go - Goroutines, Channels, and Pipelines. The following exercise is from the book, “Mastering Go: Create Golang production applications using network libraries, concurrency, machine learning, and advanced data structures” by Mihalis Tsoukalos. The book not only contains a lot of useful examples and best practices but also helps you understand the capability of Go in depth via well-written descriptions."><meta property="og:image" content="https://rayspock.com/posts/go-pipeline/gioia-m-pipeline-unsplash.jpg"><meta property="og:url" content="https://rayspock.com/posts/go-pipeline/"><meta property="og:type" content="website"><meta property="og:site_name" content="Ray Yang"><meta name=twitter:title content="Learn Go Pipelines by building keyword search tool"><meta name=twitter:description content="Photo by Gioia M. on Unsplash   Today&rsquo;s challenge is about working with concurrency in Go - Goroutines, Channels, and Pipelines. The following exercise is from the book, “Mastering Go: Create …"><meta name=twitter:image content="https://rayspock.com/posts/go-pipeline/gioia-m-pipeline-unsplash.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@rayspock675"><meta name=twitter:creator content="@rayspock675"><meta name=generator content="Hugo 0.85.0"><link rel=alternate href=https://rayspock.com/index.xml type=application/rss+xml title="Ray Yang"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://rayspock.com/css/main.css><link rel=stylesheet href=https://rayspock.com/css/staticman.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://rayspock.com/css/syntax.css><link rel=stylesheet href=https://rayspock.com/css/codeblock.css><script src=https://www.google.com/recaptcha/api.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script>(function(a,c,e,f,d,b){a.hj=a.hj||function(){(a.hj.q=a.hj.q||[]).push(arguments)},a._hjSettings={hjid:'1924229',hjsv:6},d=c.getElementsByTagName('head')[0],b=c.createElement('script'),b.async=1,b.src=e+a._hjSettings.hjid+f+a._hjSettings.hjsv,d.appendChild(b)})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=')</script><link rel=stylesheet type=text/css href=https://rayspock.com/css/blog.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-173384207-1','auto'),ga('send','pageview'))</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://rayspock.com/>Ray Yang</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=About href=/page/about/>About</a></li><li><a title=work href=/page/work/>work</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="Ray Yang" href=https://rayspock.com/><img class=avatar-img src=https://rayspock.com/img/portfolio.png alt="Ray Yang"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>Learn Go Pipelines by building keyword search tool</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p><img src=gioia-m-pipeline-unsplash.jpg alt=image></p><div class=cn><sub>Photo by <a class="au lc" target=_blank href="https://unsplash.com/@cosmorider?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Gioia M.</a> on <a class="au lc" target=_blank href="https://unsplash.com/s/photos/pipeline?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a></sub></div><br><p>Today&rsquo;s challenge is about working with concurrency in Go - Goroutines, Channels, and Pipelines. The following exercise is from the book, “Mastering Go: Create Golang production applications using network libraries, concurrency, machine learning, and advanced data structures” by Mihalis Tsoukalos. The book not only contains a lot of useful examples and best practices but also helps you understand the capability of Go in depth via well-written descriptions. I highly recommend reading through this book to keep your Go journey going smoothly and advance your programming skill with Go.</p><p>Here is the task we would like our program to achieve</p><blockquote><p>Create a pipeline that reads text files, finds the number of occurrences of a given phrase in each text file, and calculate the total number of occurrences of the phrase in all files.</p></blockquote><p>The first part of the code is the most straightforward one where we pass file paths and a phrase to the program as the command-line argument, so the program knows which files to look for for the given phrase. A <code>for</code> loop is used to iterate each file, and we are going to create goroutines to read and count the number of occurrences in each one. Finally, we will gather results from all goroutines and sum up the total.</p><p>For example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;bufio&#34;</span>
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#e6db74>&#34;os&#34;</span>
	<span style=color:#e6db74>&#34;sync&#34;</span>
	<span style=color:#e6db74>&#34;sync/atomic&#34;</span>
)

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ops</span> <span style=color:#66d9ef>int32</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) &lt; <span style=color:#ae81ff>2</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Need at least one phrase and file parameters!&#34;</span>)
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#a6e22e>phrase</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
		<span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#a6e22e>i</span>]
		<span style=color:#75715e>// TO-DO: Reads the file and finds the number of occurrences of a given phrase
</span><span style=color:#75715e></span>	}
	<span style=color:#75715e>// TO-DO: Calculate total numbers of occurrences
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;total occurrences:&#34;</span>, <span style=color:#a6e22e>total</span>)
}
</code></pre></div><p>Before we go to the next stage, we need to figure out how goroutines communicate with each other.
Golang provides a communication mechanism called “Channel” where goroutines can exchange data with others. Therefore, we can leverage Channel to collect outcomes from other goroutines like the code segment below. It takes whatever inputs from the channel(chan keyword) <code>in</code> and sums them up.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>in</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
	<span style=color:#a6e22e>total</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>in</span> {
		<span style=color:#a6e22e>total</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>x</span>
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>total</span>
}
</code></pre></div><p>The last thing is to read files and count the total occurrences of the given phrase. In the third part of the code, you can find a function <code>scanFile</code> that takes three arguments to specify file path(fn), given phrase(phrase) and channel(out). So far, you probably have an idea what Channel here is used for? In order to communicate to other entities or goroutines, we need to send out messages to the channel. There is one tiny but very important thing to mention here which is the &lt;- symbol found on the right of the <code>chan</code> keyword. It indicates a write-only channel where you can only send messages to it. On the contrary, if the &lt;- symbol is found on the left side of the <code>chan</code> keyword, then it denotes that the channel can only be used for reading only like we did with the function <code>sum</code>. In the following code segment, we read all the words from the given file and count the numbers of occurrences of the given phrase. The total occurrences <code>count</code> will be sent to the <code>out</code> channel which indicates the <code>in</code> channel in function <code>sum</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>scanFile</span>(<span style=color:#a6e22e>fn</span>, <span style=color:#a6e22e>phrase</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>out</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>fn</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Close</span>()
	<span style=color:#a6e22e>scanner</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>f</span>)
	<span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ScanWords</span>)
	<span style=color:#a6e22e>count</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Scan</span>() {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>phrase</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Text</span>() {
			<span style=color:#a6e22e>count</span><span style=color:#f92672>++</span>
		}
	}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;file:&#34;</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>(), <span style=color:#e6db74>&#34;, occurrences:&#34;</span>, <span style=color:#a6e22e>count</span>)
	<span style=color:#75715e>// send to the channel
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>out</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>count</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Err</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
		<span style=color:#66d9ef>return</span>
	}
}

</code></pre></div><p>Now, we can connect all the dots and finish our main function like the code snippet below.
Basically, we finish most of the logic and it should work as expected. However, if we attempt to execute this program, we will get an error message like: <code>fatal error: all goroutines are asleep - deadlock!</code>. This is because we forgot to close the channel where the function sum was reading messages from and because of that, the program doesn&rsquo;t know when to stop reading messages from the channel and then causes a deadlock.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) &lt; <span style=color:#ae81ff>2</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Need at least one phrase and file parameters!&#34;</span>)
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#a6e22e>phrase</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
	<span style=color:#a6e22e>A</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>)
	<span style=color:#a6e22e>jobNumbers</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
		<span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#a6e22e>i</span>]
		<span style=color:#75715e>// Reads the file and finds the number of occurrences of a given phrase
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>scanFile</span>(<span style=color:#a6e22e>fn</span>, <span style=color:#a6e22e>phrase</span>, <span style=color:#a6e22e>A</span>)
	}
	<span style=color:#75715e>// Calculate total numbers of occurrences
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>total</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>A</span>)
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;total occurrences:&#34;</span>, <span style=color:#a6e22e>total</span>)
}
</code></pre></div><p>How do we resolve it and make sure that we close the channel properly when every goroutine finishes their jobs? It is worthwhile to mention that we cannot close a closed channel in golang, therefore, only the last goroutine which finishes its jobs can close the channel.
Let’s imagine that channels are serving stations where we hold food and goroutines are the staff who serve the food. Let&rsquo;s say we would like to close the cafeteria, those serving stations need to be properly closed. Therefore, we have to assure that only the last person who finishes the serving can close the serving station, otherwise - hypothetically - others might not be able to serve food in the future.</p><p>Let&rsquo;s get back to the <code>main</code> function here below to see how we can refine it. We would need a counter which can be accessed by multiple goroutines, so that we could keep track of how many goroutines are still working and will need to use the channel. However, how do we manage states between goroutines without causing race conditions? Well, this is where <code>sync/atomic</code> comes in handy. We can setup a new variable <code>ops</code> and leverage the package <code>atomic</code> to control our state across goroutines and prevent race conditions.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ops</span> <span style=color:#66d9ef>int32</span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) &lt; <span style=color:#ae81ff>2</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Need at least one phrase and file parameters!&#34;</span>)
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#a6e22e>phrase</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
	<span style=color:#a6e22e>A</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>)
	<span style=color:#a6e22e>jobNumbers</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>
	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ops</span>, int32(<span style=color:#a6e22e>jobNumbers</span>)) <span style=color:#75715e>// to keep track of total numbers of goroutines
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
		<span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#a6e22e>i</span>]
		<span style=color:#75715e>// Reads the file and finds the number of occurrences of a given phrase
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>scanFile</span>(<span style=color:#a6e22e>fn</span>, <span style=color:#a6e22e>phrase</span>, <span style=color:#a6e22e>A</span>)
	}
	<span style=color:#75715e>// Calculate total numbers of occurrences
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>total</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sum</span>(<span style=color:#a6e22e>A</span>)
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;total occurrences:&#34;</span>, <span style=color:#a6e22e>total</span>)
}
</code></pre></div><p>The last part of the <code>scanFile</code> function is as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>scanFile</span>(<span style=color:#a6e22e>fn</span>, <span style=color:#a6e22e>phrase</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>out</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
		<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ops</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ops</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
			close(<span style=color:#a6e22e>out</span>)
			<span style=color:#66d9ef>return</span>
		}
	}()
	<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>fn</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Close</span>()
	<span style=color:#a6e22e>scanner</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>f</span>)
	<span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>ScanWords</span>)
	<span style=color:#a6e22e>count</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Scan</span>() {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>phrase</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Text</span>() {
			<span style=color:#a6e22e>count</span><span style=color:#f92672>++</span>
		}
	}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;file:&#34;</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>(), <span style=color:#e6db74>&#34;, occurrences:&#34;</span>, <span style=color:#a6e22e>count</span>)
	<span style=color:#75715e>// send to the channel
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>out</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>count</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Err</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
		<span style=color:#66d9ef>return</span>
	}
}
</code></pre></div><p>Here we add an anonymous function to manage the counter <code>ops</code> we mentioned previously. Basically, what it does is to check whether it can close the channel or not after decreasing <code>ops</code> by 1. Furthermore, use the <code>defer</code> keyword to make sure that each goroutine will remember to manage the counter when it finishes its jobs, so we can keep <code>ops</code> in-sync across goroutines. As a result, only the last goroutine to finish can scan the document and close the channel.</p><p>The source code for this tutorial is available <a href=https://github.com/rayspock/mastering-go-examples/blob/main/pipeline.go>here</a></p><p>Thank you for reading this article.</p><div class=blog-tags><a href=https://rayspock.com//tags/100daysofcode/>100daysofcode</a>&nbsp;
<a href=https://rayspock.com//tags/learning-journey/>learning-journey</a>&nbsp;
<a href=https://rayspock.com//tags/golang/>golang</a>&nbsp;
<a href=https://rayspock.com//tags/concurrency/>concurrency</a>&nbsp;
<a href=https://rayspock.com//tags/pipeline/>pipeline</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2frayspock.com%2fposts%2fgo-pipeline%2f&text=Learn%20Go%20Pipelines%20by%20building%20keyword%20search%20tool&via=rayspock675" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2frayspock.com%2fposts%2fgo-pipeline%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2frayspock.com%2fposts%2fgo-pipeline%2f&title=Learn%20Go%20Pipelines%20by%20building%20keyword%20search%20tool" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2frayspock.com%2fposts%2fgo-pipeline%2f&title=Learn%20Go%20Pipelines%20by%20building%20keyword%20search%20tool" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://rayspock.com/posts/smart-contract/ data-toggle=tooltip data-placement=top title="Let's talk about smart contracts">&larr; Previous Post</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:rayspock@protonmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/rayspock title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/rayspock675 title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/rayspock title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://rayspock.com/>rayspock</a>
&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://rayspock.com/>Ray Yang</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.85.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=https://github.com/rayspock/rayspock.github.io/tree/c4fba822129b276e3db21574663d33172273518f>c4fba822</a>]</p></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity=sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://rayspock.com/js/main.js></script><script src=https://rayspock.com/js/staticman.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://rayspock.com/js/load-photoswipe.js></script></body></html>